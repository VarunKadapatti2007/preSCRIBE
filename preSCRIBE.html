<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Transcription & Prescription System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #002fff 0%, #002fff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0099ff 0%, #0099ff 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .doctor-auth {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .doctor-auth h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .auth-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #856404;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn-auth {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            height: fit-content;
        }

        .btn-auth:hover {
            background: #218838;
        }

        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-start {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(39, 174, 96, 0.4);
        }

        .btn-start:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-stop {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-stop:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(231, 76, 60, 0.4);
        }

        .btn-stop:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-edit {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
            font-size: 0.9em;
            padding: 10px 20px;
        }

        .btn-edit:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(243, 156, 18, 0.4);
        }

        .status {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            border-radius: 20px;
            font-weight: bold;
            transition: all 0.5s ease;
        }

        .status.idle {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .status.recording {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            color: #27ae60;
            animation: pulse 2s infinite;
        }

        .status.processing {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #f39c12;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .content-area {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .section h3 {
            color: #014992;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transcript-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .transcript-area {
            height: 300px;
            background: white;
            padding: 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            resize: none;
            transition: all 0.3s ease;
        }

        .transcript-area.editable {
            border: 2px solid #f39c12;
            background: #fffbf0;
        }

        .transcript-area:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .edit-indicator {
            background: #f39c12;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            display: none;
        }

        .edit-indicator.active {
            display: inline-block;
        }

        .prescription-area {
            background: white;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #ddd;
            min-height: 300px;
        }

        .medical-info {
            margin-bottom: 20px;
        }

        .medical-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .medical-info ul {
            list-style-type: disc;
            margin-left: 20px;
        }

        .medical-info li {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .btn-print {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            margin-top: 20px;
            width: 100%;
            box-shadow: 0 10px 20px rgba(142, 68, 173, 0.3);
        }

        .btn-print:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(142, 68, 173, 0.4);
        }

        .recording-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;  
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
            animation: blink 3s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .doctor-info {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .doctor-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .auth-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="recording-indicator" id="recordingIndicator">
        üî¥RECORDING IN PROGRESS
    </div>

    <div class="container">
        <div class="header">
            <h1>AI POWERED PRESCRIPTION EXTRACTOR</h1>
            <p>‚ö†Ô∏è‚ö†Ô∏è PLEASE NOTE THAT THIS SOFTWARE IS STILL EXPERIMENTAL. I AM USING GEMINI 2.5 FLASH MODEL.
                THE MODEL MAY MAKE MISTAKES AND HENCE PLEASE ENSURE THAT THE DOCTOR VERIFIRES EACH AND EVERY SINGLE DETAIL IN
                THE PRESCRIPTION BEFORE HANDING OVER TO THE PATIENT. I, VARUN KADAPATTI, AM NOT RESPOSIBLE IN ANY WAY FOR ANY 
                ERROR CAUSED BY THE AI DURING TRANSCRIPTON AND DATA EXTRACTION PROCESS. THANK YOU ‚ö†Ô∏è‚ö†Ô∏è 
            </p>
        </div>

        <div class="main-content">
            <div class="doctor-auth" id="doctorAuth">
                <h4>‚ö†Ô∏è Doctor Registration Required</h4>
                <div class="auth-form">
                    <div class="form-group">
                        <label for="doctorName">Doctor Name:</label>
                        <input type="text" id="doctorName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="regNumber">Registration Number:</label>
                        <input type="text" id="regNumber" placeholder="Enter MMC registration number" required>
                    </div>
                    <button class="btn-auth" onclick="authenticateDoctor()">‚úÖ Set Doctor</button>
                </div>
            </div>

            <div class="doctor-info">
                <h4>Session Information</h4>
                <p><strong>Date:</strong> <span id="currentDate"></span></p>
                <p><strong>Time:</strong> <span id="currentTime"></span></p>
                <p><strong>Doctor:</strong> <span id="sessionDoctor">Not Registered</span></p>
                <p><strong>Registration:</strong> <span id="sessionRegNumber">Not Registered</span></p>
                <p><strong>Status:</strong> <span id="sessionStatus">Registration Required</span></p>
            </div>

            <div class="controls">
                <button class="btn btn-start" id="startBtn" onclick="startRecording()" disabled>
                    üü¢ Start Recording
                </button>
                <button class="btn btn-stop" id="stopBtn" onclick="stopAndPrescribe()" disabled>
                    üõë Stop & Generate Prescription
                </button>
            </div>

            <div class="status idle" id="status">
                Please set the doctor before using the service.
            </div>

            <div class="content-area">
                <div class="section">
                    <h3>
                        Live Transcript in progress
                        <div class="transcript-controls">
                            <span class="edit-indicator" id="editIndicator">Edit mode active</span>
                            <button class="btn btn-edit" id="editBtn" onclick="toggleEditMode()">
                                ‚úèÔ∏è Edit Text
                            </button>
                        </div>
                    </h3>
                    <textarea class="transcript-area" id="transcript" placeholder="Transcript appears here as you talk... Click 'Edit Text' to manually input text for testing.">Transcript appears here as you talk.....</textarea>
                </div>

                <div class="section">
                    <h3>AI generated document:</h3>
                    <div class="prescription-area" id="prescriptionArea">
                        <div style="text-align: center; color: #7f8c8d; margin-top: 100px;">
                            Pl. note that the final doc will appear here after you press "Stop Recording" and AI processes the data.
                        </div>
                    </div>
                    <button class="btn btn-print" id="printBtn" onclick="printPrescription()" style="display: none;">
                        üñ®Ô∏è Print Document
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;
        let transcript = '';
        let finalTranscript = '';
        let isAuthenticated = false;
        let isEditMode = false;
        let doctorDetails = {
            name: '',
            regNumber: ''
        };

        // Initialize the app
        function init() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Check for speech recognition support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please use Chrome or Edge.');
                return;
            }
            
            setupSpeechRecognition();
        }

        function authenticateDoctor() {
            const doctorName = document.getElementById('doctorName').value.trim();
            const regNumber = document.getElementById('regNumber').value.trim();
            
            if (!doctorName || !regNumber) {
                alert('Please enter both doctor name and reg. number.');
                return;
            }
            
            // Store doctor details
            doctorDetails.name = doctorName;
            doctorDetails.regNumber = regNumber;
            isAuthenticated = true;
            
            // Update UI
            document.getElementById('sessionDoctor').textContent = doctorName;
            document.getElementById('sessionRegNumber').textContent = regNumber;
            document.getElementById('sessionStatus').textContent = 'Ready for recording';
            document.getElementById('startBtn').disabled = false;
            
            // Hide auth form and show success
            const authDiv = document.getElementById('doctorAuth');
            authDiv.className = 'doctor-auth auth-success';
            authDiv.innerHTML = `
                <h4>‚úÖ Authentication Successful</h4>
                <p><strong>Doctor:</strong> ${doctorName} | <strong>Registration:</strong> ${regNumber}</p>
                <button class="btn-auth" id="resetAuthBtn" onclick="resetAuthentication()" style="background: #dc3545; margin-top: 10px;">Reset Authentication</button>
            `;
            
            document.getElementById('status').textContent = 'Ready to begin recording. Click "Start Recording" to begin live transcription, or use "Edit Text" to manually input text for testing.';
        }

        // Modified resetAuthentication function
        function resetAuthentication() {
            // Check if recording is in progress
            if (isRecording) {
                alert('Cannot reset authentication while recording is in progress. Please stop recording first.');
                return;
            }
            
            isAuthenticated = false;
            doctorDetails = { name: '', regNumber: '' };
            
            // Exit edit mode if active
            if (isEditMode) {
                toggleEditMode();
            }
            
            // Reset UI
            document.getElementById('sessionDoctor').textContent = 'Not authenticated';
            document.getElementById('sessionRegNumber').textContent = 'Not verified';
            document.getElementById('sessionStatus').textContent = 'Authentication required';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            
            // Show auth form again
            const authDiv = document.getElementById('doctorAuth');
            authDiv.className = 'doctor-auth';
            authDiv.innerHTML = `
                <h4>ü©∫ Doctor Registration Required</h4>
                <div class="auth-form">
                    <div class="form-group">
                        <label for="doctorName">Doctor Name:</label>
                        <input type="text" id="doctorName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="regNumber">Registration Number:</label>
                        <input type="text" id="regNumber" placeholder="Enter MMC registration number" required>
                    </div>
                    <button class="btn-auth" onclick="authenticateDoctor()">‚úÖ Authenticate</button>
                </div>
            `;
            
            document.getElementById('status').textContent = 'Please authenticate as a doctor first before starting recording.';
        }

        function toggleEditMode() {
            if (!isAuthenticated) {
                alert('Please register the doctor first.');
                return;
            }

            const transcriptArea = document.getElementById('transcript');
            const editBtn = document.getElementById('editBtn');
            const editIndicator = document.getElementById('editIndicator');
            const stopBtn = document.getElementById('stopBtn');

            if (isEditMode) {
                // Exit edit mode
                isEditMode = false;
                transcriptArea.readOnly = true;
                transcriptArea.classList.remove('editable');
                editBtn.innerHTML = '‚úèÔ∏è Edit Text';
                editIndicator.classList.remove('active');
                
                // Store the manually edited text as final transcript
                finalTranscript = transcriptArea.value;
                
                // Enable stop button if there's content
                if (finalTranscript.trim()) {
                    stopBtn.disabled = false;
                    document.getElementById('status').textContent = 'You entered text manually. Press Stop and Prescribe to get prescrption';
                }
            } else {
                // Enter edit mode
                if (isRecording) {
                    if (!confirm('Recording is in progress. Entering edit mode will stop the recording. Continue?')) {
                        return;
                    }
                    stopRecording();
                }
                
                isEditMode = true;
                transcriptArea.readOnly = false;
                transcriptArea.classList.add('editable');
                transcriptArea.focus();
                editBtn.innerHTML = ' Save Text';
                editIndicator.classList.add('active');
                document.getElementById('status').textContent = 'Edit mode active. Click "Save Text" when done';
            }
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }

        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                console.log('Speech recognition started');
            };
            
            recognition.onresult = function(event) {
                if (isEditMode) return; // Don't update if in edit mode
                
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcriptPart = event.results[i][0].transcript;
                    
                    if (event.results[i].isFinal) {
                        finalTranscript += transcriptPart + ' ';
                    } else {
                        interimTranscript += transcriptPart;
                    }
                }
                
                const transcriptElement = document.getElementById('transcript');
                transcriptElement.value = finalTranscript + interimTranscript;
                transcriptElement.scrollTop = transcriptElement.scrollHeight;
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    // Continue recognition if no speech detected
                    if (isRecording) {
                        recognition.start();
                    }
                }
            };
            
            recognition.onend = function() {
                if (isRecording && !isEditMode) {
                    recognition.start();  
                }
            };
        }

        function startRecording() {
            if (!isAuthenticated) {
                alert('Please register the doctor first.');
                return;
            }
            
            if (isEditMode) {
                alert('Please exit edit mode first by clicking "Save Text".');
                return;
            }
            
            if (!recognition) {
                alert('Speech recognition not available. Please refresh and try again.');
                return;
            }
            
            isRecording = true;
            finalTranscript = '';
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('editBtn').disabled = true;
            document.getElementById('status').className = 'status recording';
            document.getElementById('status').textContent = 'üî¥ Recording in progress...';
            document.getElementById('recordingIndicator').style.display = 'block';
            document.getElementById('transcript').value = 'Starting transcription...\n\n';
            
            // Disable reset authentication button during recording
            const resetBtn = document.getElementById('resetAuthBtn');
            if (resetBtn) {
                resetBtn.disabled = true;
                resetBtn.style.opacity = '0.5';
                resetBtn.style.cursor = 'not-allowed';
            }
            
            recognition.start();
        }

        function stopRecording() {
            isRecording = false;
            
            if (recognition) {
                recognition.stop();
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('editBtn').disabled = false;
            document.getElementById('recordingIndicator').style.display = 'none';
            
            // Re-enable reset authentication button after recording stops
            const resetBtn = document.getElementById('resetAuthBtn');
            if (resetBtn) {
                resetBtn.disabled = false;
                resetBtn.style.opacity = '1';
                resetBtn.style.cursor = 'pointer';
            }
        }

        // Modified stopAndPrescribe function
        function stopAndPrescribe() {
            if (isRecording) {
                stopRecording();
            }
            
            // Get the current text from transcript area (whether from recording or manual input)
            const currentTranscript = document.getElementById('transcript').value.trim();
            
            if (!currentTranscript || currentTranscript === 'Starting transcription...' || currentTranscript === 'Transcript appears here as you talk.....') {
                alert('No transcript available. Please record audio or enter text manually.');
                return;
            }
            
            // Update finalTranscript with current content
            finalTranscript = currentTranscript;
            
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').className = 'status processing';
            document.getElementById('status').textContent = 'Processing transcript with Gemini...';
            
            generatePrescription();
        }

        async function generatePrescription() {
            const transcriptText = finalTranscript;
            
            try {
                console.log('Starting medical analysis...');
                
                const medicalData = await analyzeMedicalContent(transcriptText);
                console.log('Analysis complete:', medicalData);
                
                // Ensure medicalData exists and has required structure
                if (!medicalData || typeof medicalData !== 'object') {
                    throw new Error('Invalid medical data returned from analysis');
                }
                
                const prescriptionHTML = `
                    <div class="medical-info">
                        <h4>FINAL PRESCRIPTION</h4>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
                        <p><strong>Doctor:</strong> ${doctorDetails.name}</p>
                        <p><strong>Registration:</strong> ${doctorDetails.regNumber}</p>
                        <p><strong>Status:</strong> AI-Powered Analysis Complete ‚úÖ</p>
                    </div>
                    
                    <div class="medical-info">
                        <h4>PATIENT INFORMATION</h4>
                        <ul>
                            ${(medicalData.patientInfo || ['Patient consultation completed']).map(info => `<li>${info}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="medical-info">
                        <h4>MEDICAL HISTORY/ALLERGIES</h4>
                        <ul>
                            ${(medicalData.allergies || ['No allergies mentioned']).map(allergy => `<li><strong>Allergy:</strong> ${allergy}</li>`).join('')}
                            ${(medicalData.medicalHistory || ['No history discussed']).map(history => `<li><strong>History:</strong> ${history}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="medical-info">
                        <h4>CURRENT SYMPTOMS/DIAGNOSIS</h4>
                        <ul>
                            ${(medicalData.symptoms || ['General consultation']).map(symptom => `<li>${symptom}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="medical-info">
                        <h4>CURRENT PRESCRIBED MEDICATIONS</h4>
                        <ul>
                            ${(medicalData.prescriptions || []).map(med => `<li><strong>${med.name || 'Unknown'}</strong> - ${med.dosage || 'As prescribed'} - ${med.instructions || 'Follow doctor instructions'}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="medical-info">
                        <h4>NEXT APPT. DETAILS</h4>
                        <ul>
                            ${(medicalData.followUp || ['Follow-up as needed']).map(instruction => `<li>${instruction}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="medical-info" style="border-top: 2px solid #3498db; padding-top: 15px; margin-top: 20px;">
                        <p><strong>Doctor's Sign:</strong> ${doctorDetails.name}</p>
                        <p><strong>MAHARASHTRA MEDICAL COUNCIL (MMC) NO:</strong> ${doctorDetails.regNumber}</p>
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            <em>Please note: Document generated using AI-powered transcript analysis\nIf you see this message, pls note that 
                                this prescription document has been VERIFIED by your doctor in charge. NO ONE WILL BE liable
                                for any issues / errors that may have taken place. By keeping this document with you,
                                you agree to the above mentioned statements. Thanks!
                                </em>
                        </p>
                    </div>
                `;
                
                document.getElementById('prescriptionArea').innerHTML = prescriptionHTML;
                document.getElementById('printBtn').style.display = 'block';
                document.getElementById('status').className = 'status idle';
                document.getElementById('status').textContent = '‚úÖ Document generated successfully... ready for next one.';
                
            } catch (error) {
                console.error('Error generating prescription:', error);
                document.getElementById('status').className = 'status idle';
                document.getElementById('status').textContent = '‚ùå Error processing with Gemini.';
                
                // Show error details and try fallback
                const errorHTML = `
                    <div style="color: #e74c3c; text-align: center; margin: 20px;">
                        <h4>‚ö†Ô∏è Error from Gemini's End. Please see following details:</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p style="margin: 15px 0;">
                            <strong>Troubleshooting Steps:</strong><br>
                            1. Check internet connection<br>
                            2. Gemini API key error is possible / Gemini's end error<br>
                            3. Contact Varun for technical support<br>
                        </p>
                        <button class="btn btn-start" onclick="generatePrescription()" style="margin: 10px;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
                
                document.getElementById('prescriptionArea').innerHTML = errorHTML;
            }
        }

        async function analyzeMedicalContent(transcript) {
            document.getElementById('status').textContent = 'Pls wait while Gemini analyzes and extracts data...';            
            try {
                const medicalData = await processWithGemini(transcript);
                return medicalData;
            } catch (error) {
                console.error('Error processing with Gemini:', error);
                document.getElementById('status').textContent = 'Error processing with Gemini: ' + error.message;
                throw error;
            }
        }

        async function processWithGemini(transcript) {
            const prompt = `
You are a medical AI assistant specialized in extracting structured medical information from doctor-patient conversation transcripts. 

IMPORTANT INSTRUCTIONS:
- Extract ONLY factual medical information that is explicitly mentioned in the conversation!
- Do NOT infer, assume, or add any medical information that isn't directly stated. You may correct certain information as per the correct medical terminology. 
Example: Sometimes the doctor means to say "Sonography" but the transcript considers it to be "Photography". You can correct such terminology.
- If there is medical history / information about the patient's relative / family member mentioned, include it in the report as it may be beneficial to the doctor!
- If specific information is not mentioned, use appropriate "Not mentioned" or "None reported" responses
- Focus on accuracy and precision - this will be used for official medical documentation

TRANSCRIPT TO ANALYZE:
"${transcript}"

Please extract and structure the medical information using the following PLAIN TEXT format. Use exactly these headings:

PATIENT_INFO:
[List patient information discussed during consultation, one item per line]

ALLERGIES:
[List any allergies mentioned, one per line. If none mentioned, write "No allergies mentioned"]

MEDICAL_HISTORY:
[List medical history items, one per line. If none discussed, write "No significant medical history discussed"]

SYMPTOMS:
[List symptoms or diagnosis mentioned, one per line. If general consultation, write "General consultation"]

PRESCRIPTIONS:
[List medications in format: Medicine Name - Dosage - Instructions, one per line. If none prescribed, write "No medications prescribed"]

FOLLOW_UP:
[List follow-up instructions, one per line. If none mentioned, write "Follow-up as needed"]

RESPOND WITH ONLY THE ABOVE FORMAT - NO OTHER TEXT OR EXPLANATIONS.
`;

            console.log('Sending request to Gemini API...');
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=AIzaSyDCAfHJd-yLqFaJ31UYzazmjJals_SIcxc`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        topK: 1,
                        topP: 0.8,
                        maxOutputTokens: 2048,
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        }
                    ]
                })
            });

            console.log('Gemini API Response Status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Gemini API Error Response:', errorText);
                throw new Error(`Gemini API error: ${response.status} ${response.statusText}. Contact Varun if this persists.`);
            }

            const data = await response.json();
            console.log('Gemini API Response Data:', data);
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                console.error('Invalid API response structure:', data);
                throw new Error('Invalid response from Gemini API - Contact Varun');
            }

            const responseText = data.candidates[0].content.parts[0].text;
            console.log('Gemini Response Text:', responseText);
            
            // Parse the plain text response
            const medicalData = parsePlainTextResponse(responseText);
            console.log('Parsed Medical Data:', medicalData);
            
            return medicalData;
        }

        function parsePlainTextResponse(responseText) {
            console.log('Parsing plain text response:', responseText);
            
            const medicalData = {
                patientInfo: [],
                allergies: [],
                medicalHistory: [],
                symptoms: [],
                prescriptions: [],
                followUp: []
            };
            
            // Split response into sections
            const sections = responseText.split(/(?=PATIENT_INFO:|ALLERGIES:|MEDICAL_HISTORY:|SYMPTOMS:|PRESCRIPTIONS:|FOLLOW_UP:)/i);
            
            sections.forEach(section => {
                const lines = section.trim().split('\n').filter(line => line.trim());
                if (lines.length === 0) return;
                
                const header = lines[0].toUpperCase();
                const content = lines.slice(1).map(line => line.trim()).filter(line => line);
                
                if (header.startsWith('PATIENT_INFO:')) {
                    medicalData.patientInfo = content.length > 0 ? content : ['Patient consultation completed'];
                } else if (header.startsWith('ALLERGIES:')) {
                    medicalData.allergies = content.length > 0 ? content : ['No allergies mentioned'];
                } else if (header.startsWith('MEDICAL_HISTORY:')) {
                    medicalData.medicalHistory = content.length > 0 ? content : ['No significant medical history discussed'];
                } else if (header.startsWith('SYMPTOMS:')) {
                    medicalData.symptoms = content.length > 0 ? content : ['General consultation'];
                } else if (header.startsWith('PRESCRIPTIONS:')) {
                    if (content.length > 0) {
                        medicalData.prescriptions = content.map(line => {
                            const parts = line.split(' - ');
                            return {
                                name: parts[0] || 'Unknown medication',
                                dosage: parts[1] || 'As prescribed',
                                instructions: parts[2] || 'Follow doctor instructions'
                            };
                        });
                    } else {
                        medicalData.prescriptions = [{ 
                            name: 'No medications prescribed', 
                            dosage: 'N/A', 
                            instructions: 'No medications prescribed during this visit' 
                        }];
                    }
                } else if (header.startsWith('FOLLOW_UP:')) {
                    medicalData.followUp = content.length > 0 ? content : ['Follow-up as needed'];
                }
            });
            
            console.log('Final parsed data:', medicalData);
            return medicalData;
        }

        function printPrescription() {
            const printContent = document.getElementById('prescriptionArea').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>preSCRIBE - Prescription Extractor</title>
                    <style>
                        body { font-family: Segoe UI, Arial, sans-serif; padding: 20px; }
                        .medical-info { margin-bottom: 30px; }
                        .medical-info h4 { color: #2c3e50; margin-bottom: 10px; }
                        ul { margin-left: 20px; }
                        li { margin-bottom: 10px; }
                        @media print {
                            body { margin: 0; padding: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>PRESCRIPTION</h1>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Initialize the app when page loads
        window.onload = init;
    </script>
</body>
</html>